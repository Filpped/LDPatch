<!DOCTYPE html>
<html lang="zh">
<head>
    <script src="https://unpkg.com/chart.js@3.9.1/dist/chart.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>共有软件包对比</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #0056b3;
        }
        .buttons {
            text-align: center;
            margin-bottom: 20px;
        }
        .buttons button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: 1px solid #ddd;
            background-color: #f5f5f5;
        }
        .buttons button:hover {
            background-color: #e5e5e5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        #content {
            margin-top: 20px;
        }
        .package {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .package-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #0056b3;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }
        .distro-container {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
        }
        .distro {
            flex: 1 1 calc(25% - 10px);
            padding: 10px;
            border: 1px solid #bbb;
            border-radius: 5px;
            background-color: #f1f8ff;
            box-sizing: border-box;
            text-align: left;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .distro strong {
            display: block;
            font-size: 16px;
            margin-bottom: 5px;
            color: #0056b3;
        }
        .patches {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .patches ul {
            margin: 0;
            padding: 0;
            list-style-type: none;
        }
        .patches li {
            margin-bottom: 5px;
            padding: 5px 0;
            position: relative;
            cursor: pointer;
        }
        .patch-detail {
            display: none;
            position: fixed;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 10;
            width: 300px;
            max-width: 90%; /* 避免超出屏幕宽度 */
            max-height: 400px; /* 限制最大高度 */
            white-space: normal;
            overflow: auto; /* 添加滚动条 */
            word-wrap: break-word; /* 长单词自动换行 */
            overflow-wrap: break-word; /* 兼容更多浏览器 */
        }

        .patches li:hover .patch-detail {
            display: block;
        }
        .pagination {
            text-align: center;
            margin-top: 20px;
        }
        .pagination button {
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            border: 1px solid #ddd;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
        }
        .pagination button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #backToTop {
            position: fixed;
            bottom: 50px;
            right: 20px;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            display: none; /* 初始隐藏 */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            text-align: center;
        }   
        #backToTop:hover {
            background-color: #0056b3;
        }

    </style>
</head>
<body>
    <h1>共有软件包对比</h1>
    <div class="buttons">
        <button onclick="loadPackages('ubuntu_debian_common')">Ubuntu 和 Debian 共有软件包</button>
        <button onclick="loadPackages('ubuntu_fedora_common')">Ubuntu 和 Fedora 共有软件包</button>
        <button onclick="loadPackages('ubuntu_openeuler_common')">Ubuntu 和 openEuler 共有软件包</button>
        <button onclick="loadPackages('debian_fedora_common')">Debian 和 Fedora 共有软件包</button>
        <button onclick="loadPackages('debian_openeuler_common')">Debian 和 openEuler 共有软件包</button>
        <button onclick="loadPackages('fedora_openeuler_common')">Fedora 和 openEuler 共有软件包</button>
        <button onclick="loadPackages('ubuntu_debian_fedora_common')">Ubuntu、Debian 和 Fedora 共有软件包</button>
        <button onclick="loadPackages('all_common')">所有发行版共有软件包</button>
    </div>

    <div id="content">
        <!-- 动态内容 -->
    </div>
    <div id="backToTop" onclick="scrollToTop()">⬆️ 回到顶部</div>


    <script>
        
        let currentCategory = ''; // 当前分类
        let currentPage = 1;      // 当前页
        const pageSize = 10;      // 每页显示的软件包数
        let totalPages = 0;      // 总页数
        

        // 加载分类数据
        function loadPackages(category, page = 1) {
            currentCategory = category;
            const url = `http://127.0.0.1:5000/packages/${category}?page=${page}&size=${pageSize}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log(data);  // 确认数据格式
                    displayPackages(data.packages, data.total, data.page, Math.ceil(data.total / data.size));
                })
                .catch(error => console.error('加载失败:', error));
        }

        function displayPackages(packages, total, page, calculatedTotalPages) {
            totalPages = calculatedTotalPages;
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = '';

            packages.forEach(pkg => {
                const packageDiv = document.createElement('div');
                packageDiv.classList.add('package');

                let pkgHTML = `<div class="package-title">${pkg.package_name}</div>`;
                pkgHTML += `<div class="distro-container">`;
                for (let distro in pkg.distributions) {
                    const distroData = pkg.distributions[distro];
                    if (distroData) {
                        pkgHTML += `<div class="distro">
                            <strong>${distro}</strong>
                            版本: ${distroData.version || '未知'}<br>
                            上游项目: <a href="${distroData.upstream_project}" target="_blank">${distroData.upstream_project || '未知'}</a><br>
                            上游版本: ${distroData.upstream_version || '未知'}<br>
                            补丁数量: ${distroData.patches.length || 0}<br>
                            补丁信息:
                            <ul class="patches">
                                    ${distroData.patches.map(patch => {
                                    return `
                                        <li onmouseover="showPatchDetail(event, '${patch.provider}', '${patch.date}', '${patch.description}')"
                                            onmouseout="hidePatchDetail(event)">
                                            ${patch.name}
                                            <div class="patch-detail"></div>
                                        </li>
                                    `;
                        }).join('')}
                    </ul>
                </div>`;

                    }
                }
                pkgHTML += `</div>`;
                packageDiv.innerHTML = pkgHTML;
                contentDiv.appendChild(packageDiv);
            });

            // 添加分页
            const paginationDiv = document.createElement('div');
            paginationDiv.classList.add('pagination');
            paginationDiv.innerHTML = `
                <div style="text-align: center; margin-top: 20px;">
                    <button ${page <= 1 ? 'disabled' : ''} onclick="previousPage()">上一页</button>
                    <span>当前页: ${page}/${totalPages} (总计: ${total})</span>
                    <button ${page >= totalPages ? 'disabled' : ''} onclick="nextPage()">下一页</button>
                    <br>
                    <input type="number" id="pageInput" min="1" max="${totalPages}" value="${page}" style="width: 50px; margin: 10px;">
                    <button onclick="jumpToPage()">跳转</button>
                </div>
            `;
            contentDiv.appendChild(paginationDiv);
        }
        
        function changePage(page) {
            if (page > 0) {
                currentPage = page;
                loadPackages(currentCategory, currentPage);
            }
        }
        // 显示补丁详情
        function showPatchDetail(event, provider, date, description) {
            const patchDetail = event.target.querySelector('.patch-detail');
            patchDetail.style.display = 'block';

            // 获取鼠标位置
            const mouseX = event.clientX;
            const mouseY = event.clientY;

            // 设置信息框位置
            const maxX = window.innerWidth - patchDetail.offsetWidth - 20; // 确保不超出右边
            const maxY = window.innerHeight - patchDetail.offsetHeight - 20; // 确保不超出下边

            patchDetail.style.left = `${Math.min(mouseX + 15, maxX)}px`;
            patchDetail.style.top = `${Math.min(mouseY + 15, maxY)}px`;


            // 填充补丁信息
            patchDetail.innerHTML = `
                <strong>提供者:</strong> ${provider || '未知'}<br>
                <strong>日期:</strong> ${date || '未知'}<br>
                <strong>描述:</strong> ${description || '无描述'}
            `;
            // 动态调整高度
            if (patchDetail.scrollHeight > 400) {
                patchDetail.style.height = '400px'; // 最大高度
                patchDetail.style.overflowY = 'scroll'; // 添加竖向滚动条
            } else {
                patchDetail.style.height = 'auto'; // 根据内容动态调整高度
                patchDetail.style.overflowY = 'hidden'; // 不需要滚动条
            }
        }

        // 隐藏补丁详情
        function hidePatchDetail(event) {
            const patchDetail = event.target.querySelector('.patch-detail');
            patchDetail.style.display = 'none';
        }
        // 上一页
        function previousPage() {
            if (currentPage > 1) {
                loadPackages(currentCategory, currentPage - 1);
                currentPage--;
            }
        }

        // 下一页
        function nextPage() {
            loadPackages(currentCategory, currentPage + 1);
            currentPage++;
        }
        function jumpToPage() {
            const pageInput = document.getElementById('pageInput');
            const page = parseInt(pageInput.value);
            if (page > 0 && page <= totalPages) {
                currentPage = page;
                loadPackages(currentCategory, page);
            } else {
                alert('请输入 1 到 ${totalPages} 之间的页码');
            }
        }
        // 回到顶部
    function scrollToTop() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

// 检测页面滚动，显示或隐藏按钮
    window.addEventListener('scroll', () => {
        const backToTopButton = document.getElementById('backToTop');
        if (window.scrollY > 300) { // 页面滚动超过300px时显示按钮
            backToTopButton.style.display = 'block';
        } else {
            backToTopButton.style.display = 'none';
        }
    });

    </script>
</body>
</html>